---
title: "Data Processing for Low Carb High Fat Diet"
subtitle: "Repeated measures on subjects"
author: "Mark Connolly"
date: "`r Sys.Date()`"
output:
  tufte::tufte_html:
    toc: true
    toc_depth: 2
    citation_package: natbib
    latex_engine: xelatex
bibliography: lchf.bib
link-citations: yes
---

```{r setup, include=FALSE}
require(knitr)
require(ggplot2)
require(readxl)
require(gdata)
require(tidyr)

library(tufte)
# invalidate cache when the tufte version changes
knitr::opts_chunk$set(tidy = FALSE, cache.extra = packageVersion('tufte'))
options(htmltools.dir.version = FALSE)
```

# Introduction
Analysis of collected observations.  Literate programming provided by the R packages `knitr` [@R-knitr] and the document template `tufte`  [@R-tufte].

# Crossover
At the start of the test, fat will predominate as the source of calories.  As the test proceeds and the energy burn rate increases (as indicated by increased heartrate), fat as a source will diminish and carbohydrate as a source will increase.  The crossover graph captures the trends and imputes the heartrate where fat and carbohydrate contribution are equal (the point where carbohydrate will start to become the predominant energy source).

## Data preparation for crossover
Set up for combining several spreadsheets into a single data frame.  The sheets must all have the same naming convention, the same sheet structure, and the same column names.

```{r}
# a filter to be used to tell the Windows operating system to limit 
# file selection to files that look like Excel
excelfilter <- matrix(c("Excel", "*.xls*"), ncol=2)

# a function that is used to ingest a conventionally named 
# and structured spreadsheet and convert the file to a 
# data frame (which is returned to the caller)
ingestvo2 <- function(afilename) {
  parts <- unlist(strsplit(basename(afilename)," "))
  columns <- 
    data.frame("subj" = as.numeric(parts[1]),
               "testnumber" = as.numeric(parts[2]),
               "testdate" = as.Date(parts[3],format="%m%d%y")
              ) 
  obsvo2 <- 
    read_excel(afilename, sheet=1, skip=4, col_names=FALSE)
  names(obsvo2) <- 
    trim(names(read_excel(afilename, sheet=1, skip=2, col_names=TRUE)))
  obsvo2$interval <- 0:(nrow(obsvo2) - 1)
  return(cbind(columns,obsvo2))
}
```

## Select and combine Excel source files
Create a list that contains user-selected files, with each file processed by the ingestvo2 function.  The data frames in the list are then bound together by row.

```{r}
# user selects source files (all with the same structure)
list_of_files <- 
  choose.files(filters = excelfilter,
              caption = "Select VO2 files to combine")
# each file is ingested to create a data frame
# each data frame is added to a list 
list_of_data_frames <- 
  lapply(list_of_files, 
        FUN=ingestvo2)  # the ingest function 
                        # defined at the start
# the data frames in the list are bound together by rows
vo2data <- do.call('rbind', list_of_data_frames)

vo2data$subj = as.factor(vo2data$subj)
```


## Subset the test subject and test number

```{r}
testnumber = 1
subject = "123456"
fuel <- 
  subset(vo2data, 
         subj==subject & 
        testnumber == testnumber)[,c("%Fat","%Carbs","HR")]
```

## Restructure the data frame
Using the `gather` [@R-tidyr] function, create a "long" form of the data to be used for the plot. Functions `head` and `tail` are used to convey the structure changes to the data frame.  The long form is used for the plot.
```{r warning=FALSE}
fuel_long <- gather(fuel,                # source data frame
                    percentage,          # column name of the key
                    `%KCal / min`,       # column name of the value
                    c(`%Fat`,`%Carbs`))  # columns that are sources of
                                         # key names and values.
head(fuel_long)   # shows the top part of the data frame
tail(fuel_long)   # shows the bottom part of the data frame
```

## Impute the crossover point
Find the heartrate where the lines cross.  The lines cross when the %fat and %carbohydrates are each 50.  The `loess` [@R-base] function fits a model to predict %Fat for the heartrate. Then the predicted %Fat value that is closest to 50 is used to index the heartrate value.  The heartrate at 50% is used to mark the crossover point on the graph.
```{r}
# fuel data frame is ordered by HR and the result
# is used to construct polynomial regression fitting of %Fat ~ HR
fatfromhrloess <-
  loess(data=fuel[order(fuel$HR),], `%Fat` ~ HR)

# A data frame is constructed for predicting %Fat for sequenc of heartrate values.
# The sequence is from the lowest observed value to the hightest observed value, 
# incremented by 1.
predictedfat <- 
  data.frame(HR=c(min(fuel$HR):max(fuel$HR)))

# Predicted values of %Fat (fat) are added to the data frame.  The values are 
# predicted using the loess fit model and the sequence of heartrates.
predictedfat$fat <- 
  predict(loess(data=fuel,`%Fat` ~ HR), 
          newdata = predictedfat)

# The predicted value of fat is used to find the closest value to 50%,
# resulting in an index to the heartrate used to impute the 50%.  
crossover <- 
  predictedfat$HR[which.min(abs(predictedfat$fat - 50))]
```

## Plot the data
The package `ggplot2` [@R-ggplot2] is used to produce the plot.
```{marginfigure}
**Note:** The graphing process can be modified to produce sets of graphs, including graphs for a subject for each test, for subjects for each test, or any combination.  *See Mark if this is desired.*
```
```{r fig-12346vo2}
ggplot(data=fuel_long,
       aes(x=HR,
           y=`%KCal / min`,
           color=percentage, 
           shape=percentage)) + 
  geom_point() + 
  geom_smooth() +
  geom_vline(xintercept = crossover) +
  ggtitle(paste("Crossover for Subject",subject)) + 
  geom_vline(xintercept = crossover,
             color = "darkgrey") +
  geom_text(x=crossover, 
            y=100, 
            label=paste("HR bpm at 50% =",
                        crossover),
            color = "darkgrey",
            show.legend = FALSE)
```

```{r include=FALSE}
# References
citPkgs <- c(names(sessionInfo()$otherPkgs), "base")
write_bib(citPkgs, file="lchf.bib")

```

