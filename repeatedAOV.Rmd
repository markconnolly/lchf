---
title: "Repeated Measures Analysis of Variance"
output: html_notebook
---
# Repeated measures analysis of variance
## Cheatsheet
A chunk is a collection of code delimited by 
```{r}
    # no code in this here comment
    a <- 1 # a little assignment
    a      # show a as output below the chunk
```
- run all chunks in the document:                 Ctrl+Alt+r
- run current chunk (where the caret is):         Ctrl+Shift+enter
- produce a document from the source and hunks:   Ctrl+Shift+K


## Low carb high fat diet
Load the various packages.

```{r setup}
# packages for analysis of repeated measures
library(nlme)
library(car)

# document definition and construction
library(knitr)
library(rmarkdown)

#reading and writing files of various types (in this case, csv and text files)
library(readr)

# data manipulation
library(tidyr)
library(dplyr)

# pipelining commands
library(magrittr)

# nice graphs
require(ggplot2)
```
### Prepare the data
```{r}
obs <- read_csv("mep_observations.csv")
obs <- obs[order(obs$Subject),]
obs$Subject <- as.factor(obs$Subject)
obs$TestNumber <- as.factor(obs$TestNumber)
kable(obs)
```
## Analysis of variance
- The dependent variable is ```MEPHR```.
- The test subject is ```Subject```.
- The factor is ```TestNumber```.

The methodology comes from https://gribblelab.wordpress.com/2009/03/09/repeated-measures-anova-using-r/

### Univariate with aov()
```{r}
aov.model <- aov(MEPHR ~ TestNumber + Error(Subject/TestNumber), data=obs)
summary(aov.model)
```
### Univariate approach using lme()
This method fits a linear mixed-effects model.
```{r}
lme.model <- lme(MEPHR ~ TestNumber, random = ~1|Subject/TestNumber, data=obs)
summary(lme.model)
```

Display F- and p-values for the factor effect.
```{r}
anova(lme.model)
```

### Multivariate approach using lm() / mlm()
1. Convert data frame to matrix. Each row of the matrix is a subject.  Each column is the test number.
```{r}
obs.matrix <- with(obs, # grabs stuf from the obs data frame
                    cbind(
                      MEPHR[TestNumber=="0"], # gets the subject observations for the base line
                      MEPHR[TestNumber=="1"], # gets the subject observations for test 1
                      MEPHR[TestNumber=="2"], #
                      MEPHR[TestNumber=="3"]
                      ) # cbind is column bind, the rows are flipped to columns in the matrix
                  )
# set row and column identities
rownames(obs.matrix) <- levels(obs$Subject)
colnames(obs.matrix) <- levels(obs$TestNumber)

# display the matrix
obs.matrix
```
2. Create a multivariate linear model from the matrix.
```{r}
mlm.model <- lm(obs.matrix ~ 1)
mlm.model

```

The coefficients are equal to the means across subjects for each test.
